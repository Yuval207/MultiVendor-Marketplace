import{D as M,c as W,a as z}from"./chunk-VMASTMKW-Ce-vIJ7v.js";import{a4 as E,ag as K,as as L,a6 as T,ai as U,R as k,S as q,j as e,b as V,at as A,i as $,r as B,ab as J,ac as O,B as D,g as Q,l as X,v as Y}from"./index-DEFeRDIL.js";import{c as Z}from"./chunk-6GU6IDUA-CDc7wW5L.js";import{K as I}from"./chunk-6HTZNHPT-HMeIdg7c.js";import{R as p,u as G}from"./chunk-BFJYVY5L-uaLHImxC.js";import"./chunk-MWVM4TYO-bKUcYSnf.js";import"./index.esm-Bh06v7m5.js";import"./index-Cf2cYblr.js";import"./checkbox-Bb3g0FAy.js";import"./prompt-DO1sEl7G.js";var ee=({form:s})=>{const{store:t}=Q(),{regions:i}=$({limit:9999}),{price_preferences:a}=X({}),{setCloseOnEscape:r}=G(),n=se({currencies:t==null?void 0:t.supported_currencies,regions:i,pricePreferences:a}),o=Y({control:s.control,name:"variants"});return e.jsx(M,{columns:n,data:o,state:s,onEditingChange:g=>r(!g)})},re=z(),se=({currencies:s=[],regions:t=[],pricePreferences:i=[]})=>{const{t:a}=V();return B.useMemo(()=>[re.column({id:a("fields.title"),header:a("fields.title"),cell:r=>{const n=r.row.original;return e.jsx(M.ReadonlyCell,{context:r,children:e.jsx("div",{className:"flex h-full w-full items-center gap-x-2 overflow-hidden",children:e.jsx("span",{className:"truncate",children:n.title})})})},disableHiding:!0}),...W({currencies:s.map(r=>r.currency_code),regions:t,pricePreferences:i,getFieldName:(r,n)=>{var o;return(o=r.column.id)!=null&&o.startsWith("currency_prices")?`variants.${r.row.index}.prices.${n}`:`variants.${r.row.index}.prices.${n}`},t:a})],[a,s,t,i])},te=E({variants:K(E({prices:L(T(),T().or(U()).optional()).optional()}))}),ie=({product:s,variantId:t})=>{var _;const{t:i}=V(),{handleSuccess:a}=G(),{mutateAsync:r,isPending:n}=A(s.id),{regions:o}=$({limit:9999}),g=B.useMemo(()=>o!=null&&o.length?o.reduce((l,d)=>(l[d.id]=d.currency_code,l),{}):{},[o]),c=t?(_=s.variants)==null?void 0:_.filter(l=>l.id===t):s.variants,j=J({defaultValues:{variants:c==null?void 0:c.map(l=>({title:l.title,prices:l.prices.reduce((d,u)=>{var m;return(m=u.rules)!=null&&m.region_id?d[u.rules.region_id]=u.amount:d[u.currency_code]=u.amount,d},{})}))},resolver:O(te,{})}),H=j.handleSubmit(async l=>{const d=l.variants.map((u,m)=>({id:c[m].id,prices:Object.entries(u.prices||{}).filter(([f,x])=>x!==""&&typeof x<"u").map(([f,x])=>{var P,w,S,C,F,N;const h=f.startsWith("reg_")?f:void 0,b=f.startsWith("reg_")?g[h]:f;let v;h?v=(S=(w=(P=c==null?void 0:c[m])==null?void 0:P.prices)==null?void 0:w.find(y=>y.rules.region_id===h))==null?void 0:S.id:v=(N=(F=(C=c==null?void 0:c[m])==null?void 0:C.prices)==null?void 0:F.find(y=>y.currency_code===b&&Object.keys(y.rules??{}).length===0))==null?void 0:N.id;const R=Z(x);return{id:v,currency_code:b,amount:R,...h?{rules:{region_id:h}}:{}}})}));await r(d,{onSuccess:()=>{a("..")}})});return e.jsx(p.Form,{form:j,children:e.jsxs(I,{onSubmit:H,className:"flex size-full flex-col",children:[e.jsx(p.Header,{}),e.jsx(p.Body,{className:"flex flex-col overflow-hidden",children:e.jsx(ee,{form:j})}),e.jsx(p.Footer,{children:e.jsxs("div",{className:"flex w-full items-center justify-end gap-x-2",children:[e.jsx(p.Close,{asChild:!0,children:e.jsx(D,{variant:"secondary",size:"small",children:i("actions.cancel")})}),e.jsx(D,{type:"submit",variant:"primary",size:"small",isLoading:n,children:i("actions.save")})]})})]})})},he=()=>{const{id:s,variant_id:t}=k(),{product:i,isLoading:a,isError:r,error:n}=q(s,{fields:"+variants,+variants.prices"});if(r)throw n;return e.jsx(p,{children:!a&&i&&e.jsx(ie,{product:i,variantId:t})})};export{he as Component};
